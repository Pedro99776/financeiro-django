{% extends 'contas/base.html' %}
{% load humanize %}

{% block content %}
<div class="container-fluid">

    <form method="get" class="row g-3 align-items-center mb-5 bg-white p-3 rounded shadow-sm">
        <input type="hidden" name="filtro_ativo" value="1">
        <div class="col-auto">
            <label class="fw-bold small text-muted">Ano:</label>
            <select name="ano" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="2024" {% if ano_atual == 2024 %}selected{% endif %}>2024</option>
                <option value="2025" {% if ano_atual == 2025 %}selected{% endif %}>2025</option>
                <option value="2026" {% if ano_atual == 2026 %}selected{% endif %}>2026</option>
            </select>
        </div>

        <div class="col-auto">
            <label class="fw-bold small text-muted">Mês:</label>
            <select name="mes" class="form-select form-select-sm" onchange="this.form.submit()" {% if eh_ano_inteiro %}disabled{% endif %}>
                <option value="1" {% if mes_atual == 1 %}selected{% endif %}>Janeiro</option>
                <option value="2" {% if mes_atual == 2 %}selected{% endif %}>Fevereiro</option>
                <option value="3" {% if mes_atual == 3 %}selected{% endif %}>Março</option>
                <option value="4" {% if mes_atual == 4 %}selected{% endif %}>Abril</option>
                <option value="5" {% if mes_atual == 5 %}selected{% endif %}>Maio</option>
                <option value="6" {% if mes_atual == 6 %}selected{% endif %}>Junho</option>
                <option value="7" {% if mes_atual == 7 %}selected{% endif %}>Julho</option>
                <option value="8" {% if mes_atual == 8 %}selected{% endif %}>Agosto</option>
                <option value="9" {% if mes_atual == 9 %}selected{% endif %}>Setembro</option>
                <option value="10" {% if mes_atual == 10 %}selected{% endif %}>Outubro</option>
                <option value="11" {% if mes_atual == 11 %}selected{% endif %}>Novembro</option>
                <option value="12" {% if mes_atual == 12 %}selected{% endif %}>Dezembro</option>
            </select>
        </div>

        <div class="col-auto d-flex align-items-center pt-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="ano_inteiro" id="chkAno" onchange="this.form.submit()" {% if eh_ano_inteiro %}checked{% endif %}>
                <label class="form-check-label fw-bold" for="chkAno">Ver Ano Inteiro</label>
            </div>
        </div>

        <div class="col text-end">
            <a href="{% url 'nova_transacao' %}" class="btn btn-primary btn-sm">
                <i class="bi bi-plus-lg"></i> Adicionar
            </a>
        </div>
    </form>

    <div class="text-center mb-5">
        <h6 class="text-uppercase text-muted ls-1">Saldo em Caixa</h6>
        <h1 class="display-3 fw-bold {% if saldo < 0 %}text-danger{% else %}text-primary{% endif %}">
            R$ {{ saldo|floatformat:2|intcomma }}
        </h1>

        <div class="row justify-content-center mt-4">
            <div class="col-md-3">
                <div class="card border-0 bg-success bg-opacity-10">
                    <div class="card-body text-center">
                        <small class="text-success fw-bold text-uppercase">Receitas</small>
                        <h4 class="text-success mb-0">R$ {{ total_receitas|floatformat:2|intcomma }}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 bg-danger bg-opacity-10">
                    <div class="card-body text-center">
                        <small class="text-danger fw-bold text-uppercase">Despesas</small>
                        <h4 class="text-danger mb-0">R$ {{ total_despesas|floatformat:2|intcomma }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold">Receitas por Categoria</div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas id="chartReceitasCat"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white fw-bold">Despesas por Categoria</div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas id="chartDespesasCat"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-white fw-bold">Fluxo de Caixa {% if eh_ano_inteiro %}(Anual){% else %}(Mensal){% endif %}</div>
        <div class="card-body">
            <div style="height: 300px;">
                <canvas id="chartFluxo"></canvas>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-white py-3">
            <h5 class="m-0 font-weight-bold text-dark"><i class="bi bi-list-ul"></i> Extrato Detalhado</h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Descrição</th>
                        <th>Categoria</th>
                        <th>Conta</th>
                        <th class="text-end">Valor</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in transacoes %}
                    <tr>
                        <td class="text-muted" style="width: 120px;">{{ t.data|date:"d/m/Y" }}</td>
                        <td class="fw-bold text-dark">{{ t.descricao|default:"-" }}</td>
                        <td><span class="badge bg-light text-dark border">{{ t.categoria.nome }}</span></td>
                        <td class="small text-muted">{{ t.conta.banco }}</td>
                        <td class="text-end fw-bold {% if t.tipo == 'D' %}text-danger{% else %}text-success{% endif %}">
                            {% if t.tipo == 'D' %}-{% endif %} R$ {{ t.valor|floatformat:2|intcomma }}
                        </td>
                        <td class="text-center">
                            <a href="{% url 'update_transacao' t.id %}" class="btn btn-sm btn-link text-secondary"><i class="bi bi-pencil"></i></a>
                            <a href="{% url 'delete_transacao' t.id %}" class="btn btn-sm btn-link text-danger"><i class="bi bi-trash"></i></a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            Nenhuma transação encontrada neste período.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {

        // --- 1. CONFIGURAÇÃO FLUXO DE CAIXA (BARRAS) ---
        new Chart(document.getElementById("chartFluxo"), {
            type: 'bar',
            data: {
                labels: {{ grafico_labels|safe }},
                datasets: [
                    { label: 'Receitas', data: {{ grafico_receitas|safe }}, backgroundColor: '#198754', borderRadius: 4 },
                    { label: 'Despesas', data: {{ grafico_despesas|safe }}, backgroundColor: '#dc3545', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
            }
        });

        // --- 2. CONFIGURAÇÃO ROSCA RECEITAS ---
        new Chart(document.getElementById("chartReceitasCat"), {
            type: 'doughnut',
            data: {
                labels: {{ cat_receitas_labels|safe }},
                datasets: [{
                    data: {{ cat_receitas_data|safe }},
                    backgroundColor: ['#20c997', '#198754', '#0f5132', '#75b798', '#a3cfbb'], // Tons de verde
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });

        // --- 3. CONFIGURAÇÃO ROSCA DESPESAS ---
        new Chart(document.getElementById("chartDespesasCat"), {
            type: 'doughnut',
            data: {
                labels: {{ cat_despesas_labels|safe }},
                datasets: [{
                    data: {{ cat_despesas_data|safe }},
                    backgroundColor: ['#dc3545', '#b02a37', '#842029', '#ea868f', '#f1aeb5'], // Tons de vermelho
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
    });
</script>

{% endblock %}